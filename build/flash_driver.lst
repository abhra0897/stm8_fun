                                      1 ;--------------------------------------------------------
                                      2 ; File Created by SDCC : free open source ANSI-C Compiler
                                      3 ; Version 4.0.0 #11528 (Linux)
                                      4 ;--------------------------------------------------------
                                      5 	.module flash_driver
                                      6 	.optsdcc -mstm8
                                      7 	
                                      8 ;--------------------------------------------------------
                                      9 ; Public variables in this module
                                     10 ;--------------------------------------------------------
                                     11 	.globl _spi_cs_idle
                                     12 	.globl _spi_cs_active
                                     13 	.globl _spi_read_8bits
                                     14 	.globl _spi_write_8bits
                                     15 	.globl _spi_write_24bits
                                     16 	.globl _flash_write_to_addr
                                     17 	.globl _flash_read_from_addr
                                     18 	.globl _flash_set_write_addr
                                     19 	.globl _flash_set_read_addr
                                     20 	.globl _flash_write_nbytes
                                     21 	.globl _flash_read_nbytes
                                     22 	.globl _flash_read_sreg
                                     23 	.globl _flash_write_sreg
                                     24 	.globl _flash_busy_wait
                                     25 	.globl _flash_erase_block
                                     26 	.globl _flash_write_enable
                                     27 	.globl _flash_erase_chip
                                     28 ;--------------------------------------------------------
                                     29 ; ram data
                                     30 ;--------------------------------------------------------
                                     31 	.area DATA
                                     32 ;--------------------------------------------------------
                                     33 ; ram data
                                     34 ;--------------------------------------------------------
                                     35 	.area INITIALIZED
                                     36 ;--------------------------------------------------------
                                     37 ; absolute external ram data
                                     38 ;--------------------------------------------------------
                                     39 	.area DABS (ABS)
                                     40 
                                     41 ; default segment ordering for linker
                                     42 	.area HOME
                                     43 	.area GSINIT
                                     44 	.area GSFINAL
                                     45 	.area CONST
                                     46 	.area INITIALIZER
                                     47 	.area CODE
                                     48 
                                     49 ;--------------------------------------------------------
                                     50 ; global & static initialisations
                                     51 ;--------------------------------------------------------
                                     52 	.area HOME
                                     53 	.area GSINIT
                                     54 	.area GSFINAL
                                     55 	.area GSINIT
                                     56 ;--------------------------------------------------------
                                     57 ; Home
                                     58 ;--------------------------------------------------------
                                     59 	.area HOME
                                     60 	.area HOME
                                     61 ;--------------------------------------------------------
                                     62 ; code
                                     63 ;--------------------------------------------------------
                                     64 	.area CODE
                                     65 ;	src/flash_driver.c: 13: void flash_write_to_addr(uint32_t addr, uint8_t *buff, uint16_t nbytes)
                                     66 ;	-----------------------------------------
                                     67 ;	 function flash_write_to_addr
                                     68 ;	-----------------------------------------
      000000                         69 _flash_write_to_addr:
                                     70 ;	src/flash_driver.c: 15: if (buff == NULL)
      000000 1E 07            [ 2]   71 	ldw	x, (0x07, sp)
      000002 26 01            [ 1]   72 	jrne	00102$
                                     73 ;	src/flash_driver.c: 16: return;
      000004 81               [ 4]   74 	ret
      000005                         75 00102$:
                                     76 ;	src/flash_driver.c: 17: spi_cs_active();
      000005 CDr00r00         [ 4]   77 	call	_spi_cs_active
                                     78 ;	src/flash_driver.c: 18: flash_set_write_addr(addr);
      000008 1E 05            [ 2]   79 	ldw	x, (0x05, sp)
      00000A 89               [ 2]   80 	pushw	x
      00000B 1E 05            [ 2]   81 	ldw	x, (0x05, sp)
      00000D 89               [ 2]   82 	pushw	x
      00000E CDr00r42         [ 4]   83 	call	_flash_set_write_addr
      000011 5B 04            [ 2]   84 	addw	sp, #4
                                     85 ;	src/flash_driver.c: 19: flash_write_nbytes(buff, nbytes);
      000013 1E 09            [ 2]   86 	ldw	x, (0x09, sp)
      000015 89               [ 2]   87 	pushw	x
      000016 1E 09            [ 2]   88 	ldw	x, (0x09, sp)
      000018 89               [ 2]   89 	pushw	x
      000019 CDr00r66         [ 4]   90 	call	_flash_write_nbytes
      00001C 5B 04            [ 2]   91 	addw	sp, #4
                                     92 ;	src/flash_driver.c: 20: spi_cs_idle();
                                     93 ;	src/flash_driver.c: 21: }
      00001E CCr00r00         [ 2]   94 	jp	_spi_cs_idle
                                     95 ;	src/flash_driver.c: 30: void flash_read_from_addr(uint32_t addr, uint8_t *buff, uint16_t nbytes)
                                     96 ;	-----------------------------------------
                                     97 ;	 function flash_read_from_addr
                                     98 ;	-----------------------------------------
      000021                         99 _flash_read_from_addr:
                                    100 ;	src/flash_driver.c: 32: if (buff == NULL)
      000021 1E 07            [ 2]  101 	ldw	x, (0x07, sp)
      000023 26 01            [ 1]  102 	jrne	00102$
                                    103 ;	src/flash_driver.c: 33: return;
      000025 81               [ 4]  104 	ret
      000026                        105 00102$:
                                    106 ;	src/flash_driver.c: 34: spi_cs_active();
      000026 CDr00r00         [ 4]  107 	call	_spi_cs_active
                                    108 ;	src/flash_driver.c: 35: flash_set_read_addr(addr);
      000029 1E 05            [ 2]  109 	ldw	x, (0x05, sp)
      00002B 89               [ 2]  110 	pushw	x
      00002C 1E 05            [ 2]  111 	ldw	x, (0x05, sp)
      00002E 89               [ 2]  112 	pushw	x
      00002F CDr00r54         [ 4]  113 	call	_flash_set_read_addr
      000032 5B 04            [ 2]  114 	addw	sp, #4
                                    115 ;	src/flash_driver.c: 36: flash_read_nbytes(buff, nbytes);
      000034 1E 09            [ 2]  116 	ldw	x, (0x09, sp)
      000036 89               [ 2]  117 	pushw	x
      000037 1E 09            [ 2]  118 	ldw	x, (0x09, sp)
      000039 89               [ 2]  119 	pushw	x
      00003A CDr00r86         [ 4]  120 	call	_flash_read_nbytes
      00003D 5B 04            [ 2]  121 	addw	sp, #4
                                    122 ;	src/flash_driver.c: 37: spi_cs_idle();
                                    123 ;	src/flash_driver.c: 38: }
      00003F CCr00r00         [ 2]  124 	jp	_spi_cs_idle
                                    125 ;	src/flash_driver.c: 45: void flash_set_write_addr(uint32_t addr)
                                    126 ;	-----------------------------------------
                                    127 ;	 function flash_set_write_addr
                                    128 ;	-----------------------------------------
      000042                        129 _flash_set_write_addr:
                                    130 ;	src/flash_driver.c: 47: spi_write_8bits(CMD_PAGE_WRITE);
      000042 4B 02            [ 1]  131 	push	#0x02
      000044 CDr00r00         [ 4]  132 	call	_spi_write_8bits
      000047 84               [ 1]  133 	pop	a
                                    134 ;	src/flash_driver.c: 48: spi_write_24bits(addr);
      000048 1E 05            [ 2]  135 	ldw	x, (0x05, sp)
      00004A 89               [ 2]  136 	pushw	x
      00004B 1E 05            [ 2]  137 	ldw	x, (0x05, sp)
      00004D 89               [ 2]  138 	pushw	x
      00004E CDr00r00         [ 4]  139 	call	_spi_write_24bits
      000051 5B 04            [ 2]  140 	addw	sp, #4
                                    141 ;	src/flash_driver.c: 49: }
      000053 81               [ 4]  142 	ret
                                    143 ;	src/flash_driver.c: 56: void flash_set_read_addr(uint32_t addr)
                                    144 ;	-----------------------------------------
                                    145 ;	 function flash_set_read_addr
                                    146 ;	-----------------------------------------
      000054                        147 _flash_set_read_addr:
                                    148 ;	src/flash_driver.c: 58: spi_write_8bits(CMD_READ_ARRAY);
      000054 4B 03            [ 1]  149 	push	#0x03
      000056 CDr00r00         [ 4]  150 	call	_spi_write_8bits
      000059 84               [ 1]  151 	pop	a
                                    152 ;	src/flash_driver.c: 59: spi_write_24bits(addr);
      00005A 1E 05            [ 2]  153 	ldw	x, (0x05, sp)
      00005C 89               [ 2]  154 	pushw	x
      00005D 1E 05            [ 2]  155 	ldw	x, (0x05, sp)
      00005F 89               [ 2]  156 	pushw	x
      000060 CDr00r00         [ 4]  157 	call	_spi_write_24bits
      000063 5B 04            [ 2]  158 	addw	sp, #4
                                    159 ;	src/flash_driver.c: 60: }
      000065 81               [ 4]  160 	ret
                                    161 ;	src/flash_driver.c: 71: void flash_write_nbytes(uint8_t *buff, uint16_t nbytes)
                                    162 ;	-----------------------------------------
                                    163 ;	 function flash_write_nbytes
                                    164 ;	-----------------------------------------
      000066                        165 _flash_write_nbytes:
                                    166 ;	src/flash_driver.c: 73: if (buff == NULL)
      000066 1E 03            [ 2]  167 	ldw	x, (0x03, sp)
      000068 26 01            [ 1]  168 	jrne	00118$
                                    169 ;	src/flash_driver.c: 74: return;
      00006A 81               [ 4]  170 	ret
                                    171 ;	src/flash_driver.c: 76: while (i < nbytes)
      00006B                        172 00118$:
      00006B 5F               [ 1]  173 	clrw	x
      00006C                        174 00109$:
      00006C 13 05            [ 2]  175 	cpw	x, (0x05, sp)
      00006E 25 01            [ 1]  176 	jrc	00141$
      000070 81               [ 4]  177 	ret
      000071                        178 00141$:
                                    179 ;	src/flash_driver.c: 78: SPI_WRITE8(buff[i]);    // since fast operation is required, directly calling the macro here
      000071 90 93            [ 1]  180 	ldw	y, x
      000073 72 F9 03         [ 2]  181 	addw	y, (0x03, sp)
      000076 90 F6            [ 1]  182 	ld	a, (y)
      000078 C7 52 04         [ 1]  183 	ld	0x5204, a
      00007B                        184 00103$:
      00007B C6 52 03         [ 1]  185 	ld	a, 0x5203
      00007E A5 02            [ 1]  186 	bcp	a, #0x02
      000080 27 F9            [ 1]  187 	jreq	00103$
                                    188 ;	src/flash_driver.c: 79: i++;
      000082 5C               [ 1]  189 	incw	x
      000083 20 E7            [ 2]  190 	jra	00109$
                                    191 ;	src/flash_driver.c: 81: }
      000085 81               [ 4]  192 	ret
                                    193 ;	src/flash_driver.c: 92: void flash_read_nbytes(uint8_t *buff, uint16_t nbytes)
                                    194 ;	-----------------------------------------
                                    195 ;	 function flash_read_nbytes
                                    196 ;	-----------------------------------------
      000086                        197 _flash_read_nbytes:
                                    198 ;	src/flash_driver.c: 94: if (buff == NULL)
      000086 1E 03            [ 2]  199 	ldw	x, (0x03, sp)
      000088 26 01            [ 1]  200 	jrne	00125$
                                    201 ;	src/flash_driver.c: 95: return;
      00008A 81               [ 4]  202 	ret
                                    203 ;	src/flash_driver.c: 97: while (i < nbytes)
      00008B                        204 00125$:
      00008B 5F               [ 1]  205 	clrw	x
      00008C                        206 00115$:
      00008C 13 05            [ 2]  207 	cpw	x, (0x05, sp)
      00008E 25 01            [ 1]  208 	jrc	00152$
      000090 81               [ 4]  209 	ret
      000091                        210 00152$:
                                    211 ;	src/flash_driver.c: 99: SPI_READ8(buff[i]); // since fast operation is required, directly calling the macro here
      000091 35 1A 52 04      [ 1]  212 	mov	0x5204+0, #0x1a
      000095                        213 00103$:
      000095 C6 52 03         [ 1]  214 	ld	a, 0x5203
      000098 A5 02            [ 1]  215 	bcp	a, #0x02
      00009A 27 F9            [ 1]  216 	jreq	00103$
      00009C                        217 00109$:
      00009C C6 52 03         [ 1]  218 	ld	a, 0x5203
      00009F 44               [ 1]  219 	srl	a
      0000A0 24 FA            [ 1]  220 	jrnc	00109$
      0000A2 90 93            [ 1]  221 	ldw	y, x
      0000A4 72 F9 03         [ 2]  222 	addw	y, (0x03, sp)
      0000A7 C6 52 04         [ 1]  223 	ld	a, 0x5204
      0000AA 90 F7            [ 1]  224 	ld	(y), a
                                    225 ;	src/flash_driver.c: 100: i++;
      0000AC 5C               [ 1]  226 	incw	x
      0000AD 20 DD            [ 2]  227 	jra	00115$
                                    228 ;	src/flash_driver.c: 102: }
      0000AF 81               [ 4]  229 	ret
                                    230 ;	src/flash_driver.c: 110: uint8_t flash_read_sreg(uint8_t sreg_no)
                                    231 ;	-----------------------------------------
                                    232 ;	 function flash_read_sreg
                                    233 ;	-----------------------------------------
      0000B0                        234 _flash_read_sreg:
      0000B0 88               [ 1]  235 	push	a
                                    236 ;	src/flash_driver.c: 112: uint8_t sreg_val = 0; 
      0000B1 0F 01            [ 1]  237 	clr	(0x01, sp)
                                    238 ;	src/flash_driver.c: 114: if (sreg_no == 1 || sreg_no == 2)
      0000B3 7B 04            [ 1]  239 	ld	a, (0x04, sp)
      0000B5 4A               [ 1]  240 	dec	a
      0000B6 26 03            [ 1]  241 	jrne	00120$
      0000B8 A6 01            [ 1]  242 	ld	a, #0x01
      0000BA 21                     243 	.byte 0x21
      0000BB                        244 00120$:
      0000BB 4F               [ 1]  245 	clr	a
      0000BC                        246 00121$:
      0000BC 4D               [ 1]  247 	tnz	a
      0000BD 26 08            [ 1]  248 	jrne	00104$
      0000BF 88               [ 1]  249 	push	a
      0000C0 7B 05            [ 1]  250 	ld	a, (0x05, sp)
      0000C2 A1 02            [ 1]  251 	cp	a, #0x02
      0000C4 84               [ 1]  252 	pop	a
      0000C5 26 1E            [ 1]  253 	jrne	00105$
      0000C7                        254 00104$:
                                    255 ;	src/flash_driver.c: 116: spi_cs_active();
      0000C7 88               [ 1]  256 	push	a
      0000C8 CDr00r00         [ 4]  257 	call	_spi_cs_active
      0000CB 84               [ 1]  258 	pop	a
                                    259 ;	src/flash_driver.c: 117: if (sreg_no == 1)
      0000CC 4D               [ 1]  260 	tnz	a
      0000CD 27 08            [ 1]  261 	jreq	00102$
                                    262 ;	src/flash_driver.c: 118: spi_write_8bits(CMD_READ_SREG_BYTE1);
      0000CF 4B 05            [ 1]  263 	push	#0x05
      0000D1 CDr00r00         [ 4]  264 	call	_spi_write_8bits
      0000D4 84               [ 1]  265 	pop	a
      0000D5 20 06            [ 2]  266 	jra	00103$
      0000D7                        267 00102$:
                                    268 ;	src/flash_driver.c: 120: spi_write_8bits(CMD_READ_SREG_BYTE2);
      0000D7 4B 35            [ 1]  269 	push	#0x35
      0000D9 CDr00r00         [ 4]  270 	call	_spi_write_8bits
      0000DC 84               [ 1]  271 	pop	a
      0000DD                        272 00103$:
                                    273 ;	src/flash_driver.c: 122: sreg_val = spi_read_8bits();
      0000DD CDr00r00         [ 4]  274 	call	_spi_read_8bits
      0000E0 6B 01            [ 1]  275 	ld	(0x01, sp), a
                                    276 ;	src/flash_driver.c: 123: spi_cs_idle();
      0000E2 CDr00r00         [ 4]  277 	call	_spi_cs_idle
      0000E5                        278 00105$:
                                    279 ;	src/flash_driver.c: 126: return sreg_val;
      0000E5 7B 01            [ 1]  280 	ld	a, (0x01, sp)
                                    281 ;	src/flash_driver.c: 127: }
      0000E7 5B 01            [ 2]  282 	addw	sp, #1
      0000E9 81               [ 4]  283 	ret
                                    284 ;	src/flash_driver.c: 135: void flash_write_sreg(uint8_t sreg_byte1, uint8_t sreg_byte2)
                                    285 ;	-----------------------------------------
                                    286 ;	 function flash_write_sreg
                                    287 ;	-----------------------------------------
      0000EA                        288 _flash_write_sreg:
                                    289 ;	src/flash_driver.c: 137: spi_cs_active();
      0000EA CDr00r00         [ 4]  290 	call	_spi_cs_active
                                    291 ;	src/flash_driver.c: 138: spi_write_8bits(CMD_WRITE_SREG);
      0000ED 4B 01            [ 1]  292 	push	#0x01
      0000EF CDr00r00         [ 4]  293 	call	_spi_write_8bits
      0000F2 84               [ 1]  294 	pop	a
                                    295 ;	src/flash_driver.c: 139: spi_write_8bits(sreg_byte1);
      0000F3 7B 03            [ 1]  296 	ld	a, (0x03, sp)
      0000F5 88               [ 1]  297 	push	a
      0000F6 CDr00r00         [ 4]  298 	call	_spi_write_8bits
      0000F9 84               [ 1]  299 	pop	a
                                    300 ;	src/flash_driver.c: 140: spi_write_8bits(sreg_byte2);
      0000FA 7B 04            [ 1]  301 	ld	a, (0x04, sp)
      0000FC 88               [ 1]  302 	push	a
      0000FD CDr00r00         [ 4]  303 	call	_spi_write_8bits
      000100 84               [ 1]  304 	pop	a
                                    305 ;	src/flash_driver.c: 141: spi_cs_idle();
                                    306 ;	src/flash_driver.c: 142: }
      000101 CCr00r00         [ 2]  307 	jp	_spi_cs_idle
                                    308 ;	src/flash_driver.c: 148: void flash_busy_wait()
                                    309 ;	-----------------------------------------
                                    310 ;	 function flash_busy_wait
                                    311 ;	-----------------------------------------
      000104                        312 _flash_busy_wait:
                                    313 ;	src/flash_driver.c: 150: while (flash_read_sreg(1) & (1 << SREG_BYTE1_BSY));
      000104                        314 00101$:
      000104 4B 01            [ 1]  315 	push	#0x01
      000106 CDr00rB0         [ 4]  316 	call	_flash_read_sreg
      000109 5B 01            [ 2]  317 	addw	sp, #1
      00010B 44               [ 1]  318 	srl	a
      00010C 25 F6            [ 1]  319 	jrc	00101$
                                    320 ;	src/flash_driver.c: 151: }
      00010E 81               [ 4]  321 	ret
                                    322 ;	src/flash_driver.c: 160: void flash_erase_block(uint32_t addr, uint8_t cmd_block_erase)
                                    323 ;	-----------------------------------------
                                    324 ;	 function flash_erase_block
                                    325 ;	-----------------------------------------
      00010F                        326 _flash_erase_block:
                                    327 ;	src/flash_driver.c: 162: spi_cs_active();
      00010F CDr00r00         [ 4]  328 	call	_spi_cs_active
                                    329 ;	src/flash_driver.c: 163: spi_write_8bits(cmd_block_erase);
      000112 7B 07            [ 1]  330 	ld	a, (0x07, sp)
      000114 88               [ 1]  331 	push	a
      000115 CDr00r00         [ 4]  332 	call	_spi_write_8bits
      000118 84               [ 1]  333 	pop	a
                                    334 ;	src/flash_driver.c: 164: spi_write_24bits(addr);
      000119 1E 05            [ 2]  335 	ldw	x, (0x05, sp)
      00011B 89               [ 2]  336 	pushw	x
      00011C 1E 05            [ 2]  337 	ldw	x, (0x05, sp)
      00011E 89               [ 2]  338 	pushw	x
      00011F CDr00r00         [ 4]  339 	call	_spi_write_24bits
      000122 5B 04            [ 2]  340 	addw	sp, #4
                                    341 ;	src/flash_driver.c: 165: spi_cs_idle();
                                    342 ;	src/flash_driver.c: 166: }
      000124 CCr00r00         [ 2]  343 	jp	_spi_cs_idle
                                    344 ;	src/flash_driver.c: 172: void flash_write_enable()
                                    345 ;	-----------------------------------------
                                    346 ;	 function flash_write_enable
                                    347 ;	-----------------------------------------
      000127                        348 _flash_write_enable:
                                    349 ;	src/flash_driver.c: 174: spi_cs_active();
      000127 CDr00r00         [ 4]  350 	call	_spi_cs_active
                                    351 ;	src/flash_driver.c: 175: spi_write_8bits(CMD_WRITE_ENABLE);
      00012A 4B 06            [ 1]  352 	push	#0x06
      00012C CDr00r00         [ 4]  353 	call	_spi_write_8bits
      00012F 84               [ 1]  354 	pop	a
                                    355 ;	src/flash_driver.c: 176: spi_cs_idle();
                                    356 ;	src/flash_driver.c: 177: }
      000130 CCr00r00         [ 2]  357 	jp	_spi_cs_idle
                                    358 ;	src/flash_driver.c: 182: void flash_erase_chip()
                                    359 ;	-----------------------------------------
                                    360 ;	 function flash_erase_chip
                                    361 ;	-----------------------------------------
      000133                        362 _flash_erase_chip:
                                    363 ;	src/flash_driver.c: 184: spi_cs_active();
      000133 CDr00r00         [ 4]  364 	call	_spi_cs_active
                                    365 ;	src/flash_driver.c: 185: spi_write_8bits(CMD_CHIP_ERASE);
      000136 4B 60            [ 1]  366 	push	#0x60
      000138 CDr00r00         [ 4]  367 	call	_spi_write_8bits
      00013B 84               [ 1]  368 	pop	a
                                    369 ;	src/flash_driver.c: 186: spi_cs_idle();
                                    370 ;	src/flash_driver.c: 187: }
      00013C CCr00r00         [ 2]  371 	jp	_spi_cs_idle
                                    372 	.area CODE
                                    373 	.area CONST
                                    374 	.area INITIALIZER
                                    375 	.area CABS (ABS)
